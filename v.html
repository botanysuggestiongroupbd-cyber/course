<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Fourth Year Course</title>
  <link rel="stylesheet" href="https://cdn.plyr.io/3.7.8/plyr.css" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <style>
    body {
      margin: 0;
      padding: 0;
      background: #000;
      overflow-x: hidden;
      font-family: Arial, sans-serif;
    }
    
    #auth-message {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.95);
      color: white;
      z-index: 1000;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      padding: 20px;
      text-align: center;
    }
    
    #auth-message h2 {
      color: #ff4444;
      margin-bottom: 20px;
    }
    
    #auth-message p {
      margin-bottom: 30px;
      font-size: 18px;
      max-width: 500px;
    }
    
    #login-btn, #logout-btn {
      padding: 12px 24px;
      background: #007bff;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 16px;
      font-weight: bold;
      transition: background 0.3s;
    }
    
    #login-btn:hover, #logout-btn:hover {
      background: #0056b3;
    }
    
    #logout-btn {
      position: fixed;
      top: 20px;
      right: 20px;
      background: #dc3545;
      z-index: 100;
      padding: 10px 20px;
    }
    
    #logout-btn:hover {
      background: #c82333;
    }
    
    #player {
      max-width: 100%;
      margin: 0 auto;
      background: #000;
      display: none;
    }
    
    .plyr--fullscreen-active {
      background: #000;
    }
    
    /* মোবাইল ডিভাইসের জন্য বিশেষ স্টাইল */
    @media (max-width: 768px) {
      #player {
        width: 100vw;
        height: 100vh;
      }
      
      .plyr {
        --plyr-color-main: #f00;
      }
      
      #auth-message {
        padding: 15px;
      }
      
      #auth-message h2 {
        font-size: 24px;
      }
      
      #auth-message p {
        font-size: 16px;
      }
      
      #logout-btn {
        top: 10px;
        right: 10px;
        padding: 8px 16px;
        font-size: 14px;
      }
    }
  </style>
</head>
<body>
  <!-- Authentication Message -->
  <div id="auth-message">
    <h2>Access Restricted</h2>
    <p>You must be logged in to view this content. Please login with your Google account to continue.</p>
    <button id="login-btn">Login with Google</button>
  </div>
  
  <!-- Logout Button (shown only when logged in) -->
  <button id="logout-btn" style="display: none;">Logout</button>
  
  <!-- Video Player -->
  <div id="player" data-plyr-provider="youtube" data-plyr-embed-id=""></div>

  <script src="https://cdn.plyr.io/3.7.8/plyr.js"></script>
  <script type="module">
    // Firebase modules
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
    import { 
      getFirestore, 
      doc,
      getDoc,
      updateDoc,
      serverTimestamp
    } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";
    import { 
      getAuth, 
      onAuthStateChanged, 
      signOut,
      GoogleAuthProvider,
      signInWithPopup 
    } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";

    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyAJn31foXlB5ooSIdZ1aGcshMu955urDQo",
      authDomain: "fouth-year.firebaseapp.com",
      projectId: "fouth-year",
      storageBucket: "fouth-year.firebasestorage.app",
      messagingSenderId: "771603556892",
      appId: "1:771603556892:web:51ae0bd68acf6678a14dd9",
      measurementId: "G-XWWT64FGJR"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    const provider = new GoogleAuthProvider();

    // DOM elements
    const authMessage = document.getElementById('auth-message');
    const playerElement = document.getElementById('player');
    const loginBtn = document.getElementById('login-btn');
    const logoutBtn = document.getElementById('logout-btn');

    // Get Firestore video ID from URL
    const urlParams = new URLSearchParams(window.location.search);
    const firestoreVideoId = urlParams.get('videoId');
    
    // Function to extract YouTube ID
    function extractYouTubeId(embedCode) {
      if (!embedCode) return null;
      const match = embedCode.match(/youtube\.com\/embed\/([a-zA-Z0-9_-]{11})/) ||
                   embedCode.match(/youtu\.be\/([a-zA-Z0-9_-]{11})/) ||
                   embedCode.match(/v=([a-zA-Z0-9_-]{11})/);
      return match ? match[1] : null;
    }
    
    // Function to check if device is mobile
    function isMobileDevice() {
      return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
    }
    
    // Login function
    async function login() {
      try {
        await signInWithPopup(auth, provider);
        console.log("Login successful");
      } catch (error) {
        console.error("Login error:", error);
        alert("Login failed: " + error.message);
      }
    }

    // Logout function
    async function logout() {
      try {
        await signOut(auth);
        console.log("Logged out");
      } catch (error) {
        console.error("Logout error:", error);
      }
    }
    
    // Load video from Firestore
    async function loadVideo() {
      if (!firestoreVideoId) {
        console.error('No video ID');
        alert('No video specified');
        return;
      }
      
      try {
        // Firestore থেকে ভিডিও ডাটা লোড করুন
        const videoRef = doc(db, 'videos', firestoreVideoId);
        const videoDoc = await getDoc(videoRef);
        
        if (!videoDoc.exists()) {
          console.error('Video not found');
          alert('Video not found');
          return;
        }
        
        const videoData = videoDoc.data();
        const youtubeId = extractYouTubeId(videoData.embedCode);
        
        if (!youtubeId) {
          console.error('Invalid video');
          alert('Invalid video URL format');
          return;
        }
        
        // প্লেয়ার এলিমেন্টে YouTube ID সেট করুন
        playerElement.setAttribute('data-plyr-embed-id', youtubeId);
        
        // Plyr প্লেয়ার ইনিশিয়ালাইজ করুন
        const player = new Plyr('#player', {
          fullscreen: {
            enabled: true,
            fallback: true,
            iosNative: true
          },
          controls: [
            'play-large',
            'play',
            'progress',
            'current-time',
            'duration',
            'mute',
            'volume',
            'captions',
            'settings',
            'pip',
            'airplay',
            'fullscreen'
          ],
          settings: ['captions', 'quality', 'speed'],
          hideControls: false,
          keyboard: { focused: true, global: true },
          tooltips: { controls: true, seek: true }
        });
        
        // ফুলস্ক্রিন ইভেন্ট হ্যান্ডলার
        player.on('enterfullscreen', event => {
          if (isMobileDevice()) {
            // মোবাইল ডিভাইসে ল্যান্ডস্কেপ করার চেষ্টা করুন
            try {
              if (screen.orientation && screen.orientation.lock) {
                screen.orientation.lock('landscape').catch(e => {
                  console.log('Orientation lock failed:', e);
                });
              }
            } catch (e) {
              console.log('Fullscreen landscape error:', e);
            }
          }
        });
        
        player.on('exitfullscreen', event => {
          // ফুলস্ক্রিন থেকে বের হলে orientation unlock করুন
          try {
            if (screen.orientation && screen.orientation.unlock) {
              screen.orientation.unlock();
            }
          } catch (e) {
            console.log('Orientation unlock error:', e);
          }
        });
        
        // মোবাইল ডিভাইসে orientation change হ্যান্ডলিং
        window.addEventListener('orientationchange', () => {
          if (isMobileDevice() && player.fullscreen.active) {
            // ফুলস্ক্রিন মোডে থাকলে ল্যান্ডস্কেপ রাখার চেষ্টা করুন
            setTimeout(() => {
              if (Math.abs(window.orientation) === 90) {
                // ডিভাইস ল্যান্ডস্কেপ মোডে আছে
                player.elements.container.style.transform = 'rotate(0deg)';
              }
            }, 300);
          }
        });
        
        console.log('Video loaded successfully:', videoData.title || 'Untitled');
        
      } catch (error) {
        console.error('Error loading video:', error);
        alert('Error loading video. Please check console.');
      }
    }

    // Check authentication state
    onAuthStateChanged(auth, (user) => {
      if (user) {
        // User is logged in
        console.log("User logged in:", user.email);
        authMessage.style.display = 'none';
        playerElement.style.display = 'block';
        logoutBtn.style.display = 'block';
        loadVideo();
      } else {
        // User is not logged in
        console.log("User not logged in");
        authMessage.style.display = 'flex';
        playerElement.style.display = 'none';
        logoutBtn.style.display = 'none';
        
        // Clear player if exists
        if (playerElement.hasAttribute('data-plyr-embed-id')) {
          playerElement.removeAttribute('data-plyr-embed-id');
        }
      }
    });

    // Event listeners
    loginBtn.addEventListener('click', login);
    logoutBtn.addEventListener('click', logout);

    // Resize handler for better mobile experience
    window.addEventListener('resize', () => {
      const player = document.querySelector('.plyr');
      if (player && isMobileDevice()) {
        if (window.innerHeight > window.innerWidth) {
          // Portrait mode
          player.style.maxHeight = '80vh';
        } else {
          // Landscape mode
          player.style.maxHeight = '100vh';
        }
      }
    });
    
  </script>
</body>
</html>
