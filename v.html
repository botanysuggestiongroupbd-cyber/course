<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Fourth Year Course</title>
  <link rel="stylesheet" href="https://cdn.plyr.io/3.7.8/plyr.css" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <style>
    body {
      margin: 0;
      padding: 0;
      background: #000;
      overflow-x: hidden;
    }
    
    #player {
      max-width: 100%;
      margin: 0 auto;
      background: #000;
    }
    
    .plyr--fullscreen-active {
      background: #000;
    }
    
    /* মোবাইল ডিভাইসের জন্য বিশেষ স্টাইল */
    @media (max-width: 768px) {
      #player {
        width: 100vw;
        height: 100vh;
      }
      
      .plyr {
        --plyr-color-main: #f00;
      }
    }
  </style>
</head>
<body>
  <div id="player" data-plyr-provider="youtube" data-plyr-embed-id=""></div>

  <script src="https://cdn.plyr.io/3.7.8/plyr.js"></script>
  <script type="module">
    // Firebase modules
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
    import { 
      getFirestore, 
      doc,
      getDoc,
      updateDoc,
      serverTimestamp
    } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyAJn31foXlB5ooSIdZ1aGcshMu955urDQo",
      authDomain: "fouth-year.firebaseapp.com",
      projectId: "fouth-year",
      storageBucket: "fouth-year.firebasestorage.app",
      messagingSenderId: "771603556892",
      appId: "1:771603556892:web:51ae0bd68acf6678a14dd9",
      measurementId: "G-XWWT64FGJR"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // Get Firestore video ID from URL
    const urlParams = new URLSearchParams(window.location.search);
    const firestoreVideoId = urlParams.get('videoId');
    
    // Function to extract YouTube ID
    function extractYouTubeId(embedCode) {
      if (!embedCode) return null;
      const match = embedCode.match(/youtube\.com\/embed\/([a-zA-Z0-9_-]{11})/) ||
                   embedCode.match(/youtu\.be\/([a-zA-Z0-9_-]{11})/) ||
                   embedCode.match(/v=([a-zA-Z0-9_-]{11})/);
      return match ? match[1] : null;
    }
    
    // Function to check if device is mobile
    function isMobileDevice() {
      return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
    }
    
    // Load video from Firestore
    async function loadVideo() {
      if (!firestoreVideoId) {
        console.error('No video ID');
        return;
      }
      
      try {
        // Firestore থেকে ভিডিও ডাটা লোড করুন
        const videoRef = doc(db, 'videos', firestoreVideoId);
        const videoDoc = await getDoc(videoRef);
        
        if (!videoDoc.exists()) {
          console.error('Video not found');
          return;
        }
        
        const videoData = videoDoc.data();
        const youtubeId = extractYouTubeId(videoData.embedCode);
        
        if (!youtubeId) {
          console.error('Invalid video');
          return;
        }
        
        // প্লেয়ার এলিমেন্টে YouTube ID সেট করুন
        const playerElement = document.getElementById('player');
        playerElement.setAttribute('data-plyr-embed-id', youtubeId);
        
        // Plyr প্লেয়ার ইনিশিয়ালাইজ করুন
        const player = new Plyr('#player', {
          fullscreen: {
            enabled: true,
            fallback: true,
            iosNative: true
          },
          controls: [
            'play-large',
            'play',
            'progress',
            'current-time',
            'duration',
            'mute',
            'volume',
            'captions',
            'settings',
            'pip',
            'airplay',
            'fullscreen'
          ],
          settings: ['captions', 'quality', 'speed'],
          hideControls: false,
          keyboard: { focused: true, global: true },
          tooltips: { controls: true, seek: true }
        });
        
        // ফুলস্ক্রিন ইভেন্ট হ্যান্ডলার
        player.on('enterfullscreen', event => {
          if (isMobileDevice()) {
            // মোবাইল ডিভাইসে ল্যান্ডস্কেপ করার চেষ্টা করুন
            try {
              if (screen.orientation && screen.orientation.lock) {
                screen.orientation.lock('landscape').catch(e => {
                  console.log('Orientation lock failed:', e);
                });
              }
            } catch (e) {
              console.log('Fullscreen landscape error:', e);
            }
          }
        });
        
        player.on('exitfullscreen', event => {
          // ফুলস্ক্রিন থেকে বের হলে orientation unlock করুন
          try {
            if (screen.orientation && screen.orientation.unlock) {
              screen.orientation.unlock();
            }
          } catch (e) {
            console.log('Orientation unlock error:', e);
          }
        });
        
        // মোবাইল ডিভাইসে orientation change হ্যান্ডলিং
        window.addEventListener('orientationchange', () => {
          if (isMobileDevice() && player.fullscreen.active) {
            // ফুলস্ক্রিন মোডে থাকলে ল্যান্ডস্কেপ রাখার চেষ্টা করুন
            setTimeout(() => {
              if (Math.abs(window.orientation) === 90) {
                // ডিভাইস ল্যান্ডস্কেপ মোডে আছে
                player.elements.container.style.transform = 'rotate(0deg)';
              }
            }, 300);
          }
        });
        
      } catch (error) {
        console.error('Error loading video:', error);
      }
    }
    
    // Load video when DOM is ready
    document.addEventListener('DOMContentLoaded', loadVideo);
    
    // Resize handler for better mobile experience
    window.addEventListener('resize', () => {
      const playerElement = document.querySelector('.plyr');
      if (playerElement && isMobileDevice()) {
        if (window.innerHeight > window.innerWidth) {
          // Portrait mode
          playerElement.style.maxHeight = '80vh';
        } else {
          // Landscape mode
          playerElement.style.maxHeight = '100vh';
        }
      }
    });
    
  </script>
</body>
</html>
